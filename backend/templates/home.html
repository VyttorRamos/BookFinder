<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home - BookFinder</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='img/BookFinderIcon.png') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>

<body>
    <style>
        /* --- ESTILOS GERAIS --- */
        :root {
            --primary: #f59e0b;
            --primary-dark: #d97706;
            --secondary: #1e293b;
            --text-main: #334155;
            --text-light: #64748b;
            --bg-light: #f8fafc;
            --white: #ffffff;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            --font-main: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --font-serif: Georgia, Cambria, "Times New Roman", Times, serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--font-main);
            color: var(--text-main);
            background-color: var(--bg-light);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        a { text-decoration: none; color: inherit; transition: color 0.2s; }
        ul { list-style: none; }

        /* HEADER */
        .app-header {
            background-color: var(--white);
            border-bottom: 1px solid #e2e8f0;
            height: 80px;
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            align-items: center;
            box-shadow: var(--shadow-sm);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-family: var(--font-serif);
            font-size: 1.4rem;
            font-weight: bold;
            color: var(--secondary);
            margin-right: 20px;
        }

        .logo-icon {
            background-color: var(--primary);
            color: white;
            padding: 6px;
            border-radius: 8px;
            display: flex;
        }

        .icon { width: 20px; height: 20px; stroke: currentColor; stroke-width: 2; fill: none; }

        .main-nav {
            display: flex;
            gap: 30px;
            align-items: center;
            margin-left: auto;
            margin-right: 30px;
        }

        .nav-link {
            font-weight: 700;
            font-size: 0.85rem;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 8px 0;
            position: relative;
        }
        .nav-link:hover { color: var(--primary); }
        .nav-link::after {
            content: ''; position: absolute; width: 0; height: 2px; bottom: 0; left: 0;
            background-color: var(--primary); transition: width 0.3s;
        }
        .nav-link:hover::after { width: 100%; }

        .btn-logout {
            color: #ef4444; font-size: 0.85rem; font-weight: 700; text-transform: uppercase;
            border: 1px solid #fee2e2; padding: 8px 20px; border-radius: 50px;
            transition: all 0.2s; background-color: #fff;
        }
        .btn-logout:hover { background-color: #ef4444; color: white; border-color: #ef4444; }

        .mobile-menu-btn { display: none; background: none; border: none; cursor: pointer; color: var(--text-main); }

        /* MAIN CONTENT */
        main { padding: 40px 20px; max-width: 1200px; margin: 0 auto; width: 100%; flex: 1; }
        h1 { font-family: var(--font-serif); font-size: 2.5rem; color: var(--secondary); margin-bottom: 10px; }
        main>p { color: var(--text-light); font-size: 1.1rem; margin-bottom: 40px; max-width: 700px; }

        /* CARDS DE LIVROS */
        .livros-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 30px;
        }

        .livro-card {
            background: var(--white);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            border: 1px solid #f1f5f9;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            flex-direction: column;
            height: 100%; /* Garante altura igual */
        }
        .livro-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-lg); }

        .livro-image {
            height: 240px;
            background-color: #f1f5f9;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
            border-bottom: 1px solid #e2e8f0;
        }
        .livro-image img { width: 100%; height: 100%; object-fit: contain; padding: 10px; transition: transform 0.3s; }
        .livro-card:hover .livro-image img { transform: scale(1.05); }
        .capa-placeholder { font-size: 3rem; color: #cbd5e1; }

        .livro-info { padding: 20px; flex: 1; display: flex; flex-direction: column; }
        .livro-info h3 {
            font-size: 1.1rem; font-weight: 700; color: var(--secondary);
            margin-bottom: 10px; line-height: 1.3;
        }
        .livro-info p {
            margin-bottom: 6px; font-size: 0.85rem; color: var(--text-light);
            display: flex; justify-content: space-between; align-items: center;
        }
        .tag {
            background-color: #fffbeb; color: #d97706; padding: 2px 8px;
            border-radius: 4px; font-weight: 600; font-size: 0.75rem; text-transform: uppercase;
        }

        /* --- NOVO: BOTÃO DE EMPRÉSTIMO --- */
        .card-footer {
            padding: 15px 20px;
            border-top: 1px solid #f1f5f9;
            margin-top: auto; /* Empurra para o final do card */
            background-color: #f8fafc;
        }

        .btn-card {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            background-color: var(--secondary);
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
            transition: background 0.2s;
            gap: 8px;
        }
        .btn-card:hover { background-color: var(--primary); }
        
        .status-badge {
            display: block;
            text-align: center;
            font-size: 0.85rem;
            color: var(--success);
            font-weight: 600;
            background-color: #dcfce7;
            padding: 8px;
            border-radius: 8px;
        }

        /* SEÇÃO RECOMENDAÇÃO */
        .recommended-section {
            background-color: #ffdbb31a; border: 1px solid #d9770640;
            padding: 30px; border-radius: 16px; margin-bottom: 60px;
        }
        .book-section h2 {
            font-size: 1.5rem; color: var(--secondary); margin-bottom: 25px;
            display: flex; align-items: center; gap: 10px;
            border-bottom: 2px solid #e2e8f0; padding-bottom: 10px;
        }

        /* LOADER */
        .ai-loader { display: flex; flex-direction: column; align-items: center; padding: 40px; }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary); border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 15px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* SEARCH */
        .search-container {
            margin-bottom: 50px; background: var(--white); padding: 30px;
            border-radius: 16px; box-shadow: var(--shadow-sm); border: 1px solid #e2e8f0;
        }
        #search-form { display: flex; gap: 15px; justify-content: center; max-width: 700px; margin: 0 auto; }
        #search-input { flex: 1; padding: 14px 20px; border: 2px solid #e2e8f0; border-radius: 10px; outline: none; }
        #search-input:focus { border-color: var(--primary); }
        .btn-primary {
            background-color: var(--secondary); color: white; border: none; padding: 0 25px;
            border-radius: 10px; font-weight: 600; cursor: pointer; display: inline-flex;
            align-items: center; justify-content: center; gap: 8px; height: 50px;
        }
        .btn-primary:hover { background-color: #0f172a; }

        /* FOOTER E RESPONSIVIDADE */
        footer { background-color: var(--white); border-top: 1px solid #e2e8f0; padding: 40px 20px; margin-top: auto; text-align: center; }
        .footer-links { display: flex; justify-content: center; gap: 20px; margin-top: 15px; }
        @media (max-width: 900px) {
            .main-nav { display: none; } .mobile-menu-btn { display: block; }
            .container { padding: 15px; } .app-header { height: auto; padding: 15px 0; }
            #search-form { flex-direction: column; } #search-form button { width: 100%; }
        }
        .flash-container { max-width: 800px; margin: 0 auto 30px auto; }
        .flash-message { padding: 15px; border-radius: 8px; text-align: center; font-weight: 600; margin-bottom: 10px; }
        .flash-message.success { background: #dcfce7; color: #166534; }
        .flash-message.error { background: #fee2e2; color: #991b1b; }
        .no-livros { text-align: center; padding: 60px; background: white; border-radius: 16px; border: 1px dashed #cbd5e1; }
    </style>
    
    <header class="app-header">
        <div class="container">
            <a href="{{ url_for('home') }}" class="logo">
                <div class="logo-icon">
                    <svg class="icon" viewBox="0 0 24 24"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>
                </div>
                BookFinder
            </a>
            <nav class="main-nav">
                <a href="{{ url_for('home') }}" class="nav-link">INÍCIO</a>
                <a href="{{ url_for('generos') }}" class="nav-link">GÊNEROS</a>
                <a href="{{ url_for('buscar_livros') }}" class="nav-link">BUSCAR LIVROS</a>
                <a href="{{ url_for('sobre') }}" class="nav-link">SOBRE</a>
                <a href="{{ url_for('contato') }}" class="nav-link">CONTATO</a>
                {% if user_type == 'admin' %}
                <a href="{{ url_for('dashboard') }}" class="nav-link admin-link">ADMIN</a>
                {% endif %}
                <a href="{{ url_for('perfil') }}" class="nav-link">PERFIL</a>
                <a href="{{ url_for('logout') }}" class="btn-logout">SAIR</a>
            </nav>
            <button class="mobile-menu-btn">
                <svg class="icon" style="width: 30px; height: 30px;" viewBox="0 0 24 24"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
            </button>
        </div>
    </header>

    <main>
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            <div class="flash-container">
              {% for category, message in messages %}
                <div class="flash-message {{ category }}">{{ message }}</div>
              {% endfor %}
            </div>
          {% endif %}
        {% endwith %}

        <h1>Bem-vindo, {{ user_name }}!</h1>
        <p>Explore nosso catálogo e descubra novas leituras para todos os gostos.</p>

        <section class="book-section recommended-section" id="section-recomendacoes" style="display: none;">
            <h2>
                <svg class="icon" style="color: #d97706;" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg>
                Recomendações para Você 
            </h2>
            <div id="ai-loader" class="ai-loader">
                <div class="spinner"></div>
                <p style="color: var(--primary-dark); font-weight: 600;">A IA está analisando seu perfil...</p>
            </div>
            <div id="ai-recommendations-grid" class="livros-grid"></div>
        </section>

        <div class="search-container">
            <form id="search-form">
                <input type="text" id="search-input" placeholder="Busque por título, autor ou categoria...">
                <button type="submit">
                    <svg class="icon" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                    Buscar
                </button>
            </form>
        </div>

        <section class="book-section all-books-section">
            <h2>
                <svg class="icon" style="color: var(--primary);" viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>
                Explore Nosso Acervo
            </h2>
            
            {% if livros %}
            <div class="livros-grid">
                {% for livro in livros %}
                <div class="livro-card" 
                     data-titulo="{{ livro.titulo.lower() }}" 
                     data-categoria="{{ livro.categoria_nome.lower() if livro.categoria_nome else '' }}"
                     data-autor="{{ livro.autor.lower() if livro.autor else '' }}">
                    
                    <div class="livro-image">
                        {% if livro.capa %}
                            <img src="{{ livro.capa if 'http' in livro.capa else url_for('static', filename='uploads/' + livro.capa) }}" alt="{{ livro.titulo }}">
                        {% else %}
                            <div class="capa-placeholder">
                                <svg class="icon" viewBox="0 0 24 24"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="livro-info">
                        <h3>{{ livro.titulo }}</h3>
                        <p><strong>ISBN:</strong> {{ livro.isbn or 'N/A' }}</p>
                        <p><strong>Ano:</strong> {{ livro.ano_publicacao or 'N/A' }}</p>
                        <p>
                            <strong>Categoria:</strong> 
                            {% if livro.categoria_nome %}
                                <span class="tag">{{ livro.categoria_nome }}</span>
                            {% else %} - {% endif %}
                        </p>
                        <p><strong>Editora:</strong> {{ livro.editora_nome or '-' }}</p>
                    </div>

                    <div class="card-footer">
                        {% if user_type == 'admin' %}
                            <a href="{{ url_for('emprestar') }}" class="btn-card">
                                <svg class="icon" viewBox="0 0 24 24"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="20" y1="8" x2="20" y2="14"></line><line x1="23" y1="11" x2="17" y2="11"></line></svg>
                                Emprestar
                            </a>
                        {% else %}
                            <span class="status-badge">Disponível</span>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="no-livros">
                <p>Nenhum livro cadastrado no momento.</p>
                {% if user_type == 'admin' %}
                <a href="{{ url_for('cadastrarlivro') }}" class="btn-primary" style="margin-top: 20px;">Cadastrar Primeiro Livro</a>
                {% endif %}
            </div>
            {% endif %}
        </section>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2024 BookFinder. Todos os direitos reservados.</p>
            <ul class="footer-links">
                <li><a href="{{ url_for('sobre') }}">Sobre</a></li>
                <li><a href="{{ url_for('contato') }}">Contato</a></li>
                <li><a href="{{ url_for('privacidade') }}">Privacidade</a></li>
                <li><a href="{{ url_for('termos') }}">Termos</a></li>
            </ul>
        </div>
    </footer>

    <script>
        // PASSANDO TIPO DE USUÁRIO PARA O JS
        const USER_TYPE = "{{ user_type }}";

        document.addEventListener('DOMContentLoaded', function() {
            console.log('[BookFinder] Home carregada.');
            const aiSection = document.getElementById('section-recomendacoes');
            const aiLoader = document.getElementById('ai-loader');
            const aiGrid = document.getElementById('ai-recommendations-grid');

            // --- IA ---
            aiSection.style.display = 'block';
            fetch('/api/recomendacoes')
                .then(response => response.json())
                .then(data => {
                    aiLoader.style.display = 'none';
                    if (data.status === 'success' && data.recomendacoes && data.recomendacoes.length > 0) {
                        aiGrid.innerHTML = '';
                        data.recomendacoes.forEach(livro => {
                            let capaSrc = livro.capa ? (livro.capa.includes('http') ? livro.capa : `/static/uploads/${livro.capa}`) : null;
                            let imgHtml = capaSrc ? `<img src="${capaSrc}" alt="${livro.titulo}">` : 
                                `<div class="capa-placeholder"><svg class="icon" viewBox="0 0 24 24"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg></div>`;

                            // LÓGICA DO BOTÃO NO JS
                            let footerHtml = '';
                            if (USER_TYPE === 'admin') {
                                footerHtml = `
                                    <div class="card-footer">
                                        <a href="/emprestar" class="btn-card">
                                            Emprestar
                                        </a>
                                    </div>`;
                            } else {
                                footerHtml = `
                                    <div class="card-footer">
                                        <span class="status-badge">Recomendado</span>
                                    </div>`;
                            }

                            const cardHtml = `
                                <div class="livro-card">
                                    <div class="livro-image">${imgHtml}</div>
                                    <div class="livro-info">
                                        <h3>${livro.titulo}</h3>
                                        <p><strong>ISBN:</strong> ${livro.isbn || 'N/A'}</p>
                                        <p><strong>Ano:</strong> ${livro.ano_publicacao || 'N/A'}</p>
                                        <p><strong>Categoria:</strong> <span class="tag" style="background-color: #e0f2fe; color: #0369a1;">IA</span></p>
                                        <p><strong>Editora:</strong> ${livro.editora_nome || '-'}</p>
                                    </div>
                                    ${footerHtml}
                                </div>`;
                            aiGrid.innerHTML += cardHtml;
                        });
                    } else {
                        aiGrid.innerHTML = `<div style="grid-column: 1/-1; text-align: center; color: #64748b;"><p>Realize empréstimos para receber recomendações personalizadas!</p></div>`;
                    }
                })
                .catch(err => {
                    aiLoader.style.display = 'none';
                    aiGrid.innerHTML = `<p style="color:red; text-align:center">Erro ao carregar sugestões.</p>`;
                });

            // BUSCA LOCAL
            const searchInput = document.getElementById('search-input');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    const term = this.value.toLowerCase().trim();
                    document.querySelectorAll('.livro-card').forEach(card => {
                        const txt = (card.getAttribute('data-titulo') || '') + (card.getAttribute('data-categoria') || '') + (card.getAttribute('data-autor') || '');
                        card.style.display = txt.includes(term) || card.innerText.toLowerCase().includes(term) ? 'flex' : 'none';
                    });
                });
                document.getElementById('search-form').addEventListener('submit', e => e.preventDefault());
            }

            // MENU MOBILE
            const menuBtn = document.querySelector('.mobile-menu-btn');
            const mainNav = document.querySelector('.main-nav');
            if (menuBtn) {
                menuBtn.addEventListener('click', () => {
                    const isHidden = getComputedStyle(mainNav).display === 'none';
                    if (isHidden) {
                        mainNav.style.display = 'flex';
                        mainNav.style.flexDirection = 'column';
                        mainNav.style.position = 'absolute';
                        mainNav.style.top = '80px';
                        mainNav.style.left = '0';
                        mainNav.style.width = '100%';
                        mainNav.style.background = 'white';
                        mainNav.style.padding = '20px';
                        mainNav.style.boxShadow = '0 4px 6px rgba(0,0,0,0.1)';
                    } else {
                        mainNav.style.display = 'none';
                    }
                });
            }
            
            setTimeout(() => { document.querySelectorAll('.flash-message').forEach(a => a.style.display = 'none'); }, 5000);
        });
    </script>
</body>
</html>